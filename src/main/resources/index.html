<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css"/>
    <script data-require="jquery@*" data-semver="3.1.1"
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #container {
            border: 1px solid brown;
        }

        H1 {
            float: left;
        }

        .button {
            background-color: #55A;
            border: 1px solid #229;
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }

        .add-tag {
            background-color: #56A;
            border: 1px solid #229;
            width: 60px;
            float: right;
            color: white;
            float: left;
        }

        #receiptList {
            border: 1px solid green;
            clear: both;
        }

        .receipt {
            background-color: #eee;
            margin-bottom: 5px;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        const api = ""; // <- do not need a root api URL if this page is served directly by the API

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        $(document).ready(function () {

            function attach_tags() {
                var classname = document.getElementsByClassName("add-tag");

                var myFunction = function() {
                    alert("wtf?");
                };

                for (var i = 0; i < classname.length; i++) {
                    classname[i].addEventListener('click', myFunction, false);
                }
            }

            function refresh_receipt(receipts) {

                document.getElementById("receiptList").innerHTML = "";

                for (var i = 0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    $(`<div class="receipt">
                    Name : <span class="merchant">${receipt.merchantName}</span> <br>
                    Amount : <span class="amount">${receipt.value}</span> <br>
                    Tags : <span class="tags">${receipt.tagsRecordList}</span> <br>
                    Time : ${receipt.value}
                    <div class="add-tag" data-id=${receipt.id}>Add Tag</div>
                    </div>`).appendTo($("#receiptList"));

                }
                attach_tags();
            }

            function main() {
                $.ajax({
                    url: api + "/receipts",
                    success: function (data) {
                        refresh_receipt(data);
                    }
                })
            }

            main();

            p_test = document.getElementById("add-receipt");
            p_test.style.display = "none";

            plus_button = document.getElementById("plus_button");

            plus_button.addEventListener("click", myFunction);

            function myFunction() {
                p_test.style.display = "initial";
            }

            call_test = document.getElementById("save-receipt");
            call_test.addEventListener("click", myFunction2);

            call_test = document.getElementById("cancel-receipt");
            call_test.addEventListener("click", cancel_function);

            function myFunction2() {
                if (document.getElementById("amount").value) {
                    data_load = {
                        merchant: document.getElementById("merchant").value,
                        amount: document.getElementById("amount").value
                    };
                } else {
                    data_load = {
                        merchant: document.getElementById("merchant").value,
                    };
                }
                $.ajax({
                    url: api + "/receipts",
                    type: "POST", dataType: "text",
                    data: JSON.stringify(data_load),
                    contentType: "application/json",
                    async : false,
                    complete: main(),
//                        function () {
//                        $(`<div class="receipt">
//                    Name : <span class="merchant">${document.getElementById("merchant").value}</span> <br>
//                    Amount : <span class="amount">${document.getElementById("merchant").value}</span> <br>
//                    Tags : <span class="tags">[]</span> <br>
//                    Time : ${document.getElementById("merchant").value}
//                    </div>`).appendTo($("#receiptList"));
//                    },
                })
            }

            function cancel_function() {
                document.getElementById("merchant").value = "";
                document.getElementById("amount").value = "";
                p_test.style.display = "none"
            }
        });
    </script>
</head>

<body>
<DIV id="container">

    <div id="add-receipt">
        <div>MerchantName : <input id="merchant"/></div><br>
        <div>Amount : <input id="amount" /></div>
        <div class="button" id="save-receipt">Save</div><br><br>
        <div class="button" id="cancel-receipt">Cancel</div><br><br><hr>
    </div>

    <h1>My receipts</h1>
    <div class="button" id="plus_button">+</div>
    <div id="receiptList">
    </div>
</DIV>
</body>

</html>
