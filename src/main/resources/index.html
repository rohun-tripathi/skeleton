<!DOCTYPE html>
<html>

<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #container {
            border: 1px solid brown;
        }

        H1 {
            float: left;
        }

        .button {
            background-color: #55A;
            border: 1px solid #229;
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
        }

        .add-tag {
            background-color: #56A;
            border: 1px solid #229;
            width: 60px;
            float: right;
            color: white;
            float: left;
        }

        video {
            width: 550px;
            height: 450px;
            border: 1px solid black;
        }


        #receiptList {
            border: 1px solid green;
            clear: both;
        }
        video {
            width: 550px;
            height: 450px;
            border: 1px solid black;
            align-self : center;
        }

        .receipt {
            background-color: #eee;
            margin-bottom: 5px;
        }

        #vidwrap {
            margin: 20px 0;
        }

        .trial{
            background-color: #56A;
            border: 1px solid #229;
            width: 60px;
            float: right;
            color: white;
            float: left;
        }

        #start-camera, #take-pic, #take-pic-cancel {
            align-self : center;
            height: 3em;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        const api = ""; // <- do not need a root api URL if this page is served directly by the API

        var receipt_data = [];

        function remove_tag(element) {
            $.ajax({
                url: api + "/tags/" + element.value,
                type: "PUT", dataType: "text",
                data: element.parentNode.id,
                contentType: "application/json",
                async: false,
                complete: function(data) {
                    element.remove()
                }
            });
        }

        function add_tag_to_receipt(tagName, receipt_id) {
            $('.trial', $('.receipt')[receipt_id - 1]).append(`<button class="tagValue" onclick="remove_tag(this)" value=` + tagName + `>` + tagName+`</button>`)
        }

        function attach_tags() {
            var classname = document.getElementsByClassName("add-tag");

            var myFunction = function() {
                console.log(this.parentNode);

                input_node = $('<input class="tag_input">Tag 1</input>')[0];

                this.parentNode.appendChild(input_node);

                input_node.addEventListener('keydown', function (event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        console.log(input_node.parentNode.id);
                        if (input_node.value) {
                            $.ajax({
                                url: api + "/tags/" + input_node.value,
                                type: "PUT", dataType: "text",
                                data: input_node.parentNode.id,
                                contentType: "application/json",
                                async: false,
                                complete: function (data) {
                                    add_tag_to_receipt(input_node.value, input_node.parentNode.id);
                                },
                            });
                            input_node.remove();
                        } else {
                            alert("wtf?")
                        }
                    }
                });
            };

            for (var i = 0; i < classname.length; i++) {
                classname[i].addEventListener('click', myFunction, false);
            }
        }

        function refresh_receipt(receipts) {

            document.getElementById("receiptList").innerHTML = "";

            for (var i = 0; i < receipts.length; i++) {
                var receipt = receipts[i];

                var processed = $(`<div class="receipt" id=${receipt.id}>
                    Name : <span class="merchant">${receipt.merchantName}</span> <br>
                    Amount : <span class="amount">${receipt.value}</span> <br>
                    Time : ${receipt.time}
                    <span class="trial" id=${receipt.id}/>
                    <div class="add-tag" data-id=${receipt.id}>Add Tag</div>
                    </div>`);

                processed.appendTo($("#receiptList"));

                for (var j = 0; j < receipt.tagsRecordList.length; j++) {
                    $('.trial', $('.receipt')[i]).append(`<button class="tagValue" onclick="remove_tag(this)" value=` + receipt.tagsRecordList[j] + `>` + receipt.tagsRecordList[j]+`</button>`)
                }
            }
            attach_tags();
        }

        function main() {
            $.ajax({
                url: api + "/receipts",
                success: function (data) {
                    receipt_data = data;
                    refresh_receipt(data);
                }
            })
        }

        function display_save_receipt_box() {
            document.getElementById("save_receipt_box").style.display = "initial";
        }

        function disableSnapshot() {
            $('video').remove();

            $('#take-pic').prop('disabled', true);
            $('#take-pic-cancel').prop('disabled', true);
        }

        function refresh_video_area() {
            $('video').on('play', (function(){
                $('#take-pic').prop('disabled', false);
                $('#take-pic-cancel').prop('disabled', false);
            }));
            $('#take-pic').on('click', takeSnapshot);
            $('#take-pic-cancel').on('click', disableSnapshot);
        }

        $(document).ready(function () {

            main();

            p_test = document.getElementById("save_receipt_box");
            p_test.style.display = "none";

            plus_button = document.getElementById("add-receipt");
            plus_button.addEventListener("click", display_save_receipt_box);

            call_test = document.getElementById("save-receipt");
            call_test.addEventListener("click", myFunction2);

            call_test = document.getElementById("cancel-receipt");
            call_test.addEventListener("click", cancel_function);

            function myFunction2() {
                if (document.getElementById("amount").value) {
                    data_load = {
                        merchant: document.getElementById("merchant").value,
                        amount: document.getElementById("amount").value
                    };
                } else {
                    data_load = {
                        merchant: document.getElementById("merchant").value,
                    };
                }
                $.ajax({
                    url: api + "/receipts",
                    type: "POST",
                    data: JSON.stringify(data_load),
                    contentType: "application/json",
                    success: function(data) {
                        const receipt = {};
                        receipt.merchantName = data_load.merchant;
                        receipt.value = data_load.amount;
                        receipt.id = parseInt(data.responseJSON);
                        receipt.time = (new Date()).toTimeString().split(' ')[0];
                        receipt.tagsRecordList = [];

                        receipt_data = receipt_data.concat(receipt);
                        refresh_receipt(receipt_data);
                        cancel_function();
                    }
                })
            }

            function cancel_function() {
                document.getElementById("merchant").value = "";
                document.getElementById("amount").value = "";
                p_test.style.display = "none"
            }

            $('#start-camera').on('click', startVideo);
            refresh_video_area();

            console.log('asdf');

        });

        let imageCapture;
        let track;

        function attachMediaStream(mediaStream) {
            console.log('attachMediaStream');
            $('video')[0].srcObject = mediaStream;

            // Saving the track allows us to capture a photo
            track = mediaStream.getVideoTracks()[0];
            imageCapture = new ImageCapture(track);
        }

        function startVideo() {
            console.log('startVideo');

            $('video').remove();

            $('#vidwrap').append(`<video autoplay></video>`);

            refresh_video_area();

            navigator.mediaDevices.getUserMedia({video: {facingMode: {exact: "environment"}}})
                .then(attachMediaStream)
                .catch(error => {
                    navigator.mediaDevices.getUserMedia({video: true})
                        .then(attachMediaStream)
                        .catch(error => {
                            console.log('you are fooked');
                        })
                })
        }

        function takeSnapshot() {
            console.log('takeSnapshot');
            // create a CANVAS element that is same size as the image
            imageCapture.grabFrame()
                .then(img => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;

                    canvas.getContext('2d').drawImage(img, 0, 0);
                    const base64EncodedImageData = canvas.toDataURL('image/png').split(',')[1];
                    $.ajax({
                        url: "/images",
                        type: "POST",
                        data: base64EncodedImageData,
                        contentType: "text/plain",
                        success: function (data) {

                            console.log(data);
                            console.log(data.merchantName);

                            display_save_receipt_box();
                            document.getElementById("merchant").value = data.merchantName;
                            document.getElementById("amount").value = data.amount;

                            disableSnapshot();
                        },
                    })
                        .then(response => {
                            $('video').after(`<div>got response: <pre>${JSON.stringify(response)}</pre></div>`);
                        })
                        .always(() => console.log('request complete'));

                    // For debugging, you can uncomment this to see the frame that was captured
                    // $('BODY').append(canvas);
                });
        }
    </script>
</head>

<body>
<DIV id="container">

    <div id="save_receipt_box">
        <div>MerchantName : <input id="merchant"/></div><br>
        <div>Amount : <input id="amount" /></div>
        <div class="button" id="save-receipt">Save</div><br><br>
        <div class="button" id="cancel-receipt">Cancel</div><br><br><hr>
    </div>

    <h1>My receipts</h1>
    <div class="button" id="add-receipt">+</div>
    <div id="receiptList">
    </div>
</DIV>

<button id="start-camera">Start Video</button>
<button id="take-pic" disabled="true">Take a Snapshot!</button>
<button id="take-pic-cancel" disabled="true">Cancel Snapshot!</button>
<br>
<div id="vidwrap">
    <!--<video autoplay></video>-->
</div>

</body>

</html>
